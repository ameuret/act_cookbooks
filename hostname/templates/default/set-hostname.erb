#!/bin/bash
# Adapted from
# http://ternarylabs.com/2010/09/15/automatically-configure-hostname-for-new-ec2-instances/

<%Chef::Config[:node_name] =~ /^([a-z]+)\.(.+)/ %>
  
DOMAIN=<%=node[:act_hostname][:domain]%>
HOSTNAME=<%=node[:act_hostname][:hostname]%>
IPV4=`/usr/bin/curl -s http://169.254.169.254/latest/meta-data/public-ipv4`

# Set the host name
hostname $HOSTNAME
echo $HOSTNAME > /etc/hostname

# Add fqdn to hosts file
cat<<EOF > /etc/hosts
# This file is automatically generated by ec2/set-hostname script
127.0.0.1 localhost
$IPV4 $HOSTNAME.$DOMAIN $HOSTNAME
EOF
